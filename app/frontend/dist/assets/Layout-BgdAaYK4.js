import{r as s,j as e,a as P,f as w,b as G,R as L,c as ee,u as se,h as F,O as te}from"./index-BAIcLLuA.js";import{B as D}from"./Button-CuXPXjAA.js";const re=({layout:i,type:o,message:p,onClose:m})=>{const g={info:"bg-blue-500 bg-opacity-10 border-blue-500 text-blue-100",error:"bg-red-500 bg-opacity-10 border-red-500 text-red-100",success:"bg-green-500 bg-opacity-10 border-green-500 text-green-100",warning:"bg-yellow-500 bg-opacity-10 border-yellow-500 text-yellow-100"},x={info:"bg-blue-500",error:"bg-red-500",success:"bg-green-500",warning:"bg-yellow-500"},[u,v]=s.useState(3e3);return s.useEffect(()=>{u>0&&setTimeout(()=>v(f=>f-20),20)},[u]),e.jsxs("div",{className:`alert absolute z-20 ${i?"top-full":""} right-2 backdrop-brightness-0 font-medium border-l-4
			flex flex-col border alert rounded ${g[o]}`,role:"alert",children:[e.jsxs("div",{className:"flex items-center justify-between h-[98%] lp:p-6 p-3",children:[e.jsxs("div",{className:"flex gap-3 items-center mr-4",children:[e.jsx("img",{src:`/assets/images/icons/${o}.png`,className:"alert-icon",alt:""}),e.jsx("span",{children:p})]}),e.jsx("button",{className:"focus:outline-none px-2",onClick:m,children:"Ã—"})]}),e.jsx("div",{className:`${x[o]} h-0.5 rounded-r`,style:{width:`${u/3e3*100}%`}})]})},ne="https://localhost";function ae({setIsDropdownOpen:i,user_data:o}){const{logout:p}=P(),m=()=>{i(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(w,{to:`/profile/${o.username}`,children:e.jsxs("div",{onClick:m,className:"flex items-center gap-1",children:[e.jsx("img",{src:`${ne}${o.profile_picture}`,className:"rounded-full object-cover ring-1 ring-primary dropdown-user-photo",alt:"user photo"}),e.jsxs("div",{className:"font-medium",children:[e.jsxs("p",{className:"text-primary fullname",children:[o.first_name," ",o.last_name]}),e.jsxs("p",{className:"text-light username",children:["@",o.username]})]})]})}),e.jsx("div",{className:"h-px w-[80%] bg-border self-center"}),e.jsxs("ul",{className:"font-medium text-primary flex flex-col tb:gap-2.5 gap-1.5",children:[e.jsx(w,{to:`/profile/${o.username}`,children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/profile.svg",alt:"profile icon"}),"Profile"]})}),e.jsx(w,{to:"/dashboard",children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/dashboard.svg",alt:"dashboard icon"}),"Dashboard"]})}),e.jsx(w,{to:"/settings",children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/settings.svg",alt:"settings icon"}),"Settings"]})})]}),e.jsx("div",{className:"h-[1px] w-[80%] bg-border self-center"}),e.jsx("ul",{children:e.jsxs("li",{onClick:p,className:"flex items-center gap-4 hover:brightness-150 cursor-pointer",children:[e.jsx("img",{src:"/assets/images/icons/log-out.svg",alt:"logout icon"}),"Log Out"]})})]})}const W="https://localhost",oe="https://localhost/api/friend_request/accept/",ie="https://localhost/api/friend_request/cancel/";function ce({notifications:i,setNotifications:o,setIsNotificationOpen:p}){const{getAuthHeaders:m}=P(),{triggerAlert:g}=G();U();const{handleGameInviteResponse:x}=U(),u=(r,t)=>{g(r,t)},v=async r=>{if(!r){console.error("No friend request ID provided");return}try{const t=await fetch(`${oe}${r}/`,{method:"POST",headers:m()}),a=await t.json();t.status===201?(o(d=>d.filter(b=>b.id!==r)),u("success",a.message)):(console.error("Error accepting friend request --->",a.message),o(d=>d.filter(b=>b.id!==r)),u("error",a.message)),p(!1)}catch{u("error","Error accepting friend request")}},f=async r=>{if(!r){console.error("No friend request ID provided");return}try{const t=await fetch(`${ie}${r}/`,{method:"POST",headers:m()}),a=await t.json();t.status===201?(o(d=>d.filter(b=>b.id!==r)),u("success",a.message)):u("error",a.message),p(!1)}catch(t){console.error("Error canceling friend request:",t),p(!1),u("error","Error canceling friend request")}};s.useEffect(()=>{(async()=>{try{const t=await fetch(`${W}/api/friend_ship_request/`,{headers:m()});if(t.ok){const d=(await t.json()).map(b=>({...b,flag:"true"}));o(d)}else console.error("Failed to fetch notifications")}catch(t){console.error("Error fetching notifications:",t)}})()},[]),s.useEffect(()=>{(async()=>{try{const t=await fetch(`${W}/api/game/pending-game-invites/`,{headers:m()});if(t.ok){const a=await t.json();o(d=>[...d.filter(j=>j.type!=="game_invite"),...a])}}catch(t){console.error("Error fetching pending invites:",t)}})()},[]);const S=(r,t)=>{x(r,t),o(a=>a.filter(d=>d.invitation_id!==r))},y=({notification:r,onExpire:t,onResponse:a})=>{const[d,b]=s.useState(()=>{const I=Math.floor(Date.now()/1e3)-r.created_at;return Math.max(60-I,0)}),[j,O]=s.useState(d===0);s.useEffect(()=>{if(d===0){O(!0),t();return}const k=setInterval(()=>{b(I=>{const C=I-1;return C<=0?(clearInterval(k),O(!0),t(),0):C})},1e3);return()=>clearInterval(k)},[d,t]);const $=k=>{if(j){g("error","Cannot respond to expired invitation");return}a(r.invitation_id,k)};return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:r.profile_picture,className:"mtb:border aspect-square object-cover border-0.7 border-primary rounded-full notification-img",alt:"User Avatar"}),e.jsxs("div",{children:[e.jsxs("p",{children:[r.from_user," invited you to play!"]}),e.jsxs("p",{className:`text-sm ${d<=10?"text-red-400":"text-gray-400"}`,children:["Expires in ",Math.floor(d),"s"]})]})]}),e.jsxs("div",{className:"flex gap-1 mr-1",children:[e.jsx(D,{className:`notification-buttons rounded-md ${j?"opacity-50 cursor-not-allowed":""}`,onClick:()=>$("accept"),disabled:j,children:"Accept"}),e.jsx(D,{className:`notification-buttons rounded-md ${j?"opacity-50 cursor-not-allowed":""}`,onClick:()=>$("decline"),disabled:j,children:"Decline"})]})]})},_=(r,t)=>r.type==="game_invite"?e.jsxs(L.Fragment,{children:[e.jsx(y,{notification:r,onExpire:()=>{o(a=>a.filter(d=>d.invitation_id!==r.invitation_id))},onResponse:S}),t<i.length-1&&e.jsx("div",{className:"h-px w-[80%] bg-border self-center"})]},t):e.jsxs(L.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:r.profile_picture,className:"mtb:border object-cover aspect-square border-0.7 border-primary rounded-full notification-img",alt:"User Avatar"}),r.flag?e.jsxs("p",{children:[r.username," sent you a Friend Request!"]}):e.jsxs("p",{children:[r.from_user," sent you a Friend Request!"]})]}),e.jsxs("div",{className:"flex gap-1 mr-1",children:[e.jsx(D,{className:"notification-buttons rounded-md",onClick:()=>v(r.id),children:"Accept"}),e.jsx(D,{className:"notification-buttons rounded-md",onClick:()=>f(r.id),children:"Cancel"})]})]}),t<i.length-1&&e.jsx("div",{className:"h-px w-[80%] bg-border self-center"})]},t),h=()=>e.jsxs("div",{className:"flex-1 flex flex-col justify-center items-center",children:[e.jsx("img",{src:"/assets/images/emptyStates/notifications.svg",className:"w-[50%]",alt:"notification empty state"}),e.jsx("h2",{className:"",children:"No notifications"}),e.jsx("p",{className:"font-regular bio",children:"Notification Inbox Empty"})]});return e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"font-heavy notification-header",children:"Notifications"}),e.jsx("div",{className:"flex flex-col tb:gap-3 gap-2 overflow-auto lp:mx-3 mx-2 mb-2 font-medium",children:(i==null?void 0:i.length)>0?i.map((r,t)=>_(r,t)):h()})]})}s.createContext();const le="https://localhost";function de({user_data:i,notifications:o,setNotifications:p}){const m=ee().pathname.split("/").slice(1,2),[g,x]=s.useState(!1),[u,v]=s.useState(!1),f=s.useRef(null),S=s.useRef(null),y=s.useRef(null),_=s.useRef(null);s.useEffect(()=>{const t=a=>{g&&f.current&&!f.current.contains(a.target)&&!S.current.contains(a.target)&&x(!1),u&&y.current&&!y.current.contains(a.target)&&!_.current.contains(a.target)&&v(!1)};return document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}},[g,u]);const h=()=>{x(!g),v(!1)},r=()=>{v(!u),x(!1)};return e.jsxs("header",{className:`relative flex items-center justify-between text-primary header-margin font-medium
			lp:border-b-2 border-b-[1px] border-white header-border header-height max-ms:justify-end z-50`,children:[e.jsx(he,{layout:!0}),e.jsx(w,{to:"/dashboard","aria-label":"Go to Dashboard",children:e.jsx("img",{alt:"logo",src:"/assets/images/logo.webp",className:"select-none pointer-events-none header-logo max-ms:hidden"})}),e.jsx(w,{to:"/dashboard",children:e.jsx("h1",{className:"leading-[1.1] text-primary font-dreamscape select-none header-title-font max-ml:hidden",children:"starserve"})}),e.jsxs("nav",{className:"relative flex justify-between ml:gap-x-2.5 ms:gap-x-1.5",children:[e.jsx("div",{className:`relative ${m[0]==="chat"?"pointer-events-none":""}`,children:e.jsx(w,{to:"/chat",children:e.jsx("img",{src:"/assets/images/icons/chat.svg",alt:"chat icon",className:`nav-icons select-none ${m[0]==="chat"?"":"hover:brightness-200 transition duration-300"}`})})}),e.jsxs("button",{ref:_,onClick:r,className:"relative",children:[e.jsx("img",{src:"/assets/images/icons/notification.svg",alt:"notification icon",className:"nav-icons select-none hover:brightness-200 transition duration-300"}),!u&&e.jsx("div",{className:`flex justify-center items-center bg-red-600 border border-[#0B0B0B]
						h-[30%] absolute rounded-full right-0 top-0`,children:(o==null?void 0:o.length)>0?e.jsx("p",{className:"font-heavy text-[10px] p-0.5",children:o.length>99?"+99":o.length}):null})]}),e.jsx("div",{ref:y,className:`notification max-ms:w-full absolute z-50 ml:right-1/3 right-0
							top-full flex flex-col border border-primary rounded-xl bg-secondary
							transition-opacity duration-300 ${u?"opacity-100":"pointer-events-none opacity-0"}`,children:e.jsx(ce,{notifications:o,setNotifications:p,setIsNotificationOpen:v})}),e.jsxs("button",{ref:S,onClick:h,type:"button",className:"relative",children:[e.jsx("img",{src:`${le}${i.profile_picture}`,alt:"user photo",className:"nav-icons object-cover rounded-full ring-1 ring-primary select-none"}),e.jsx("div",{className:`flex justify-center items-center bg-secondary border border-[#0B0B0B]
						w-[34%] h-[34%] absolute z-10 rounded-full right-0 bottom-0`,children:e.jsx("img",{src:"/assets/images/icons/Arrow-dropdown.svg",className:`w-[60%] select-none duration-300 ${g?"rotate-180":""}`,alt:"arrow icon"})})]}),e.jsx("div",{ref:f,className:`dropdown absolute right-0 top-full flex flex-col border border-primary rounded-xl bg-secondary
						transition-opacity duration-300 ${g?"opacity-100":"pointer-events-none opacity-0"}`,children:e.jsx(ae,{setIsDropdownOpen:x,user_data:i})})]})]})}const me="https://localhost/api/user/",ue="wss://localhost/ws/notify/",fe="wss://localhost/ws/friends/",ge="wss://localhost/ws/notifications/",q=s.createContext(),U=()=>s.useContext(q);function we(){const{authTokens:i,getAuthHeaders:o}=P(),[p,m]=s.useState(0),[g,x]=s.useState(null),[u,v]=s.useState(null),[f,S]=s.useState(null),[y,_]=s.useState([]),{triggerAlert:h}=G(),r=se(),t=()=>{m(n=>n+1)},[a,d]=s.useState({first_name:"",last_name:"",email:"",mobile_number:"",username:"",bio:"",password:"",new_password:"",confirm_password:"",profile_picture:"",is_logged_with_oauth_for_2fa:!1}),[b,j]=s.useState(""),[O,$]=s.useState(""),[k,I]=s.useState(""),[C,M]=s.useState(""),[pe,J]=s.useState(""),[xe,z]=s.useState(!1),[be,H]=s.useState(""),[Q,Y]=s.useState("");s.useState(""),s.useState("");const B=async()=>{try{const n=await fetch(me,{method:"GET",headers:o()}),l=await n.json();return n.ok?l:(F.remove("access_token"),F.remove("refresh_token"),window.location.href="/",null)}catch(n){return console.log(n),null}},[E]=s.useState(sessionStorage.getItem("tabId")||Math.random().toString(36).substr(2,9));s.useEffect(()=>{sessionStorage.setItem("tabId",E)},[]),s.useEffect(()=>{if(!(i!=null&&i.access_token)){logout();return}(async()=>{const l=await B();l?d(l):console.log("-- Failed to fetch user data --")})()},[i,p]),s.useEffect(()=>{a&&(j(a.first_name),$(a.last_name),I(a.email),M(a.mobile_number),J(a.username),H(a.bio),Y(a.profile_picture),z(a.is_logged_with_oauth_for_2fa))},[a]);const A=F.get("access_token");if(!A)return;s.useEffect(()=>{const n=new WebSocket(ue+"?access_token="+A);return n.onopen=()=>{},n.onmessage=l=>{JSON.parse(l.data)},n.onclose=l=>{},n.onerror=l=>{},x(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]),s.useEffect(()=>{const n=new WebSocket(fe+"?access_token="+A);return n.onopen=()=>{},n.onmessage=l=>{JSON.parse(l.data)},n.onclose=l=>{},n.onerror=l=>{},v(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]),s.useEffect(()=>{const n=new WebSocket(ge+"?access_token="+A);return n.onopen=()=>{},n.onmessage=l=>{const c=JSON.parse(l.data);switch(c.type){case"game_invite":_(N=>[...N,{type:"game_invite",from_user:c.sender.username,profile_picture:c.sender.profile_picture,sender_id:c.sender.id,invitation_id:c.invitation_id,created_at:c.created_at}]);break;case"invite_failed":h("error",c.message);break;case"game_invite_accepted":const R=c.sender.id===c.user.id,V=c.acceptingTabId===E,X=localStorage.getItem("gameSenderTab"),Z=R&&X===E;if(c.sender.status==="offline"){h("info",`${c.sender.username} is offline`);return}if(c.sender.status==="ingame"){h("info",`${c.sender.username} is in a game`);return}R?h("success",`${c.receiver.username} accepted your invitation`):h("success","Starting game..."),(R&&Z||!R&&V)&&(console.log("Navigating to matchmaking in tab:",E),localStorage.setItem("activeGame",JSON.stringify({gameId:c.invitation_id,activeTabId:E,timestamp:Date.now()})),r("/matchmaking",{state:{backgroundId:1,currentUser:c.user,isDirectMatch:!0,invitationId:c.invitation_id}}));break;case"game_invite_declined":c.sender.id===c.user.id&&h("info",`${c.receiver.username} declined your game invitation`);break;case"game_invite_expired":_(N=>N.filter(T=>T.invitation_id!==c.invitation_id)),h("info","Game invitation expired");break;case"error":c.message.includes("expired")?_(N=>N.filter(T=>T.invitation_id!==c.invitation_id)):h("error",c.message);break;default:_(N=>[...N,{id:c.id,message:c.message,type:"friend_request",from_user:c.from_user,profile_picture:c.profile_picture}])}},n.onclose=l=>{},n.onerror=l=>{console.error("WebSocket Error:",l)},S(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]);const K={socket_notify:g,socket_friends:u,socket_notification:f,refreshUserData:t,fetchUser:B,profile_picture:Q,handleGameInviteResponse:(n,l)=>{(f==null?void 0:f.readyState)===WebSocket.OPEN&&f.send(JSON.stringify({type:"game_invite_response",invitation_id:n,response:l,acceptingTabId:E}))},sendGameInvite:n=>{if((f==null?void 0:f.readyState)===WebSocket.OPEN){const l=sessionStorage.getItem("tabId");localStorage.setItem("gameSenderTab",l),f.send(JSON.stringify({type:"game_invite",receiver_id:n,senderTabId:l})),h("success","Game invitation sent successfullyy")}else h("error","Cannot send invite - connection error")}};return e.jsx(q.Provider,{value:K,children:e.jsxs("div",{className:"relative flex flex-col min-h-screen backdrop-blur-sm bg-backdrop-40 text-primary overflow-hidden",children:[e.jsx(de,{user_data:a,notifications:y,setNotifications:_}),e.jsx(te,{})]})})}const he=({layout:i})=>{const{showAlert:o,alertType:p,alertMessage:m,dismissAlert:g}=G();return s.useEffect(()=>{if(o){const x=setTimeout(()=>{g()},3200);return()=>clearTimeout(x)}},[o,g]),o&&e.jsx(re,{layout:i,type:p,message:m,onClose:g})};export{he as AlertWrapper,we as default,U as useSocket};
