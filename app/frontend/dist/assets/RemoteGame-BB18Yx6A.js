import{R as ee,r as c,j as a,u as se,c as te,b as ae,L as ne}from"./index-DKFyDtO4.js";/* empty css             */import{G as re,T as ie}from"./GameScore-BjMi0Jnl.js";/* empty css                    */import{C as le}from"./react-confetti.min-DTfgXLFg.js";const oe=l=>{const s=c.useCallback((o,f="profile")=>o?o.startsWith("http")||o.startsWith("/assets")?o:`https://localhost${o}`:"/assets/images/default-avatar.png",[]),e=c.useMemo(()=>s(l.playerImage,"profile"),[l.playerImage,s]),t=c.useMemo(()=>s(l.badgeImage,"badge"),[l.badgeImage,s]),g=c.useMemo(()=>l.PlayerName.length>11?l.PlayerName.slice(0,11)+"...":l.PlayerName,[l.PlayerName]);return a.jsxs("div",{className:`${l.id===1?"mtb:left-0 left-3":"mtb:right-0 right-3"} max-lg:-bottom-10 max-lg:top-full
			absolute flex flex-col items-center ${l.isPaused?"brightness-[20%]":"brightness-[1]"}
			avatar aspect-square xl:gap-12 lg:gap-10 tb:gap-5 gap-3`,children:[a.jsxs("div",{className:"relative rounded-full border border-primary",children:[a.jsx("img",{src:e,alt:"user photo",className:"match-user-image aspect-square object-cover rounded-full",onError:o=>{o.target.src="/assets/images/default-avatar.png"}}),a.jsx("img",{src:t,alt:"badge",className:`absolute z-10 bottom-0 ${l.id===1?"-left-5":"-right-5"} w-[60%]`})]}),a.jsxs("div",{children:[a.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:g}),a.jsx("h6",{className:"font-dreamscape-sans text-level",children:l.BadgeName})]})]})},H=ee.memo(oe),ce=({gameState:l,onPaddleMove:s,playerNumber:e,isPaused:t,handlePause:g,isGameOver:o,pausesRemaining:f,pausingPlayer:b,backgroundId:v,opponentDisconnected:n})=>{const x=c.useRef(null),I=c.useRef(null),j=c.useRef(null),[_,C]=c.useState({width:800,height:400}),E=1200,[N,G]=c.useState(!1),[k,y]=c.useState(!1);return c.useEffect(()=>{if(!l||!x.current)return;x.current.getContext("2d");const w=i=>{i.clearRect(0,0,_.width,_.height)},p=(i,d,u,T)=>{i.shadowBlur=0,i.shadowColor=T,i.fillStyle=T,i.beginPath(),i.moveTo(d+8.6,u),i.lineTo(d+16-8.6,u),i.quadraticCurveTo(d+16,u,d+16,u+8.6),i.lineTo(d+16,u+80-8.6),i.quadraticCurveTo(d+16,u+80,d+16-8.6,u+80),i.lineTo(d+8.6,u+80),i.quadraticCurveTo(d,u+80,d,u+80-8.6),i.lineTo(d,u+8.6),i.quadraticCurveTo(d,u,d+8.6,u),i.closePath(),i.fill(),i.shadowBlur=0},P=(i,d)=>{if(!d)return;i.shadowBlur=0,i.shadowColor="white",i.beginPath();const u=e===2?_.width-d.x:d.x;i.arc(u,d.y,10,0,Math.PI*2),i.fillStyle="white",i.fill(),i.closePath(),i.shadowBlur=0},R=(i,d,u)=>{if(!d.player1||!d.player2)return;const T=_.width-16-5,D=5;u===1?(p(i,T,d.player1.y,"white"),p(i,D,d.player2.y,"white")):(p(i,T,d.player2.y,"white"),p(i,D,d.player1.y,"white"))},A=()=>{if(!l||!x.current)return;const i=x.current.getContext("2d");w(i),P(i,l.ball),R(i,l,e)},U=()=>{A(),j.current=requestAnimationFrame(U)};return U(),()=>{j.current&&cancelAnimationFrame(j.current)}},[l,_.width,_.height]),c.useEffect(()=>{const m=p=>{p.key==="ArrowUp"&&(p.preventDefault(),s("startUp")),p.key==="ArrowDown"&&(p.preventDefault(),s("startDown"))},w=p=>{p.key==="ArrowUp"&&(p.preventDefault(),s("stopUp")),p.key==="ArrowDown"&&(p.preventDefault(),s("stopDown"))};return window.addEventListener("keydown",m),window.addEventListener("keyup",w),()=>{window.removeEventListener("keydown",m),window.removeEventListener("keyup",w)}},[s]),c.useEffect(()=>{if(!l||t)return;const w=setInterval(()=>{N&&s("up"),k&&s("down")},16);return()=>clearInterval(w)},[t,N,k,s]),a.jsxs("div",{ref:I,className:"relative flex flex-col items-center lp:gap-7 gap-3 max-lp:w-full",children:[a.jsx("canvas",{ref:x,width:_.width,height:_.height,className:`game-table aspect-video border ${t?"brightness-[20%]":"brightness-[1]"}`,style:{borderRadius:"25px",width:"100%",height:"auto",maxWidth:`${E}px`,backgroundSize:"cover",backgroundPosition:"center",backgroundImage:`url('/assets/images/tables/table${v}.${v>6?"gif":"webp"}')`}}),t&&a.jsx("div",{children:a.jsx("p",{className:`text-[100px] font-dreamscape text-center leading-[1.01] game-paused
					absolute transform top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2`,children:n?"OPPONENT DISCONNECTED...":"GAME PAUSED"})}),!o&&a.jsxs("button",{onClick:g,disabled:!t&&f[e]<=0||t&&b!==e,className:`pause flex items-center gap-3 brightness-[1] leading-[0.95] ${!t&&f[e]<=0||t&&b!==e?"opacity-50 cursor-not-allowed":""}`,children:[a.jsx("img",{src:`/assets/images/icons/${t?"play":"pause"}.svg`,alt:""}),a.jsx("p",{className:"align-middle",children:t?"resume":`pause (${f[e]} left)`})]})]})},de="https://localhost";class he{constructor(){this.socket=null,this.callbacks={},this.isConnected=!1,this.connectionAttempts=0,this.maxRetries=1,this.reconnectTimeout=null,this.gameId=null,this.userId=null,this.playerNumber=null}connect(s,e,t){if(!s||!t)return;this.gameId=s,this.playerNumber=e,this.userId=t;const g=de.replace("https://","");this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null);try{const o=`wss://${g}/ws/game/${s}/`;this.socket&&(this.socket.close(),this.socket=null),this.socket=new WebSocket(o),this.setupEventHandlers()}catch(o){this.handleError(o)}}sendPlayerNumber(){this.send({type:"player_number_init",player_number:this.playerNumber,player_id:this.userId})}handlePlayerNumberConfirmed(s){var e,t;(t=(e=this.callbacks).player_number_confirmed)==null||t.call(e,s)}setupEventHandlers(){this.socket.onopen=this.handleOpen.bind(this),this.socket.onclose=this.handleClose.bind(this),this.socket.onerror=this.handleError.bind(this),this.socket.onmessage=this.handleMessage.bind(this)}handleOpen(){var s,e;this.isConnected=!0,this.connectionAttempts=0,(e=(s=this.callbacks).connect)==null||e.call(s),this.sendPlayerNumber()}handleClose(s){var e,t;this.isConnected=!1,!s.wasClean&&this.connectionAttempts<this.maxRetries?(this.connectionAttempts++,this.reconnectTimeout=setTimeout(()=>this.connect(this.gameId),1e3)):(t=(e=this.callbacks).disconnect)==null||t.call(e)}handleError(s){var e,t;(t=(e=this.callbacks).error)==null||t.call(e,s)}handleMessage(s){try{const e=JSON.parse(s.data);e.type==="game_info"&&(this.playerNumber=e.player_number);const g={game_info:this.handleGameInfo.bind(this),player_number_confirmed:this.handlePlayerNumberConfirmed.bind(this),game_state_update:this.handleGameStateUpdate.bind(this),paddles_update:this.handlePaddlesUpdate.bind(this),ball_update:this.handleBallUpdate.bind(this),score_update:this.handleScoreUpdate.bind(this),game_ended:this.handleGameEnded.bind(this),game_started:this.handleGameStarted.bind(this),game_paused:this.handleGamePaused.bind(this),game_resumed:this.handleGameResumed.bind(this),ready_players_count:this.handleReadyPlayersCount.bind(this),pause_timeout_warning:this.handlePauseTimeoutWarning.bind(this),player_temporary_disconnect:this.handleTemporaryDisconnect.bind(this),player_reconnected:this.handlePlayerReconnected.bind(this),game_restarted:this.handleGameRestarted.bind(this),player_disconnected:this.handlePlayerDisconnected.bind(this),waiting_for_player:this.handleWaitingForPlayer.bind(this),error:this.handleServerError.bind(this)}[e.type];g&&g(e)}catch(e){this.handleError(e)}}handleGameInfo(s){var e,t;(t=(e=this.callbacks).game_info)==null||t.call(e,s)}handleGameStateUpdate(s){var e,t;(t=(e=this.callbacks).game_state_update)==null||t.call(e,s)}handlePaddlesUpdate(s){var e,t;(t=(e=this.callbacks).paddles_update)==null||t.call(e,s)}handleBallUpdate(s){var e,t;(t=(e=this.callbacks).ball_update)==null||t.call(e,s)}handleScoreUpdate(s){var e,t;(t=(e=this.callbacks).score_update)==null||t.call(e,s)}handleGameEnded(s){var e,t;(t=(e=this.callbacks).game_ended)==null||t.call(e,s)}handleGameStarted(s){var e,t;(t=(e=this.callbacks).game_started)==null||t.call(e,s)}handleGamePaused(s){var e,t;(t=(e=this.callbacks).game_paused)==null||t.call(e,s)}handleGameResumed(s){var e,t;(t=(e=this.callbacks).game_resumed)==null||t.call(e,s)}handleGameRestarted(s){var e,t;(t=(e=this.callbacks).game_restarted)==null||t.call(e,s)}handlePlayerDisconnected(s){var e,t;(t=(e=this.callbacks).player_disconnected)==null||t.call(e,s)}handleReadyPlayersCount(s){var e,t;(t=(e=this.callbacks).ready_players_count)==null||t.call(e,s)}handleWaitingForPlayer(s){var e,t;(t=(e=this.callbacks).waiting_for_player)==null||t.call(e,s)}handleServerError(s){var e,t;(t=(e=this.callbacks).error)==null||t.call(e,new Error(s.message))}handlePauseTimeoutWarning(s){var e,t;(t=(e=this.callbacks).pause_timeout_warning)==null||t.call(e,s)}handleTemporaryDisconnect(s){var e,t;(t=(e=this.callbacks).player_temporary_disconnect)==null||t.call(e,s)}handlePlayerReconnected(s){var e,t;(t=(e=this.callbacks).player_reconnected)==null||t.call(e,s)}send(s){if(this.isSocketConnected())try{this.socket.send(JSON.stringify(s))}catch(e){this.handleError(e)}}sendPaddleMove(s){this.send({type:"paddle_direction",action:s})}sendPlayerReady(){this.send({type:"player_ready"})}sendStartGame(){this.send({type:"start_game"})}sendRestartGame(){this.send({type:"restart_game"})}on(s,e){typeof e=="function"&&(this.callbacks[s]=e)}off(s){this.callbacks[s]&&delete this.callbacks[s]}disconnect(){this.maxRetries=0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.socket&&(this.isConnected=!1,this.socket.close(),this.socket=null)}isSocketConnected(){var s;return this.isConnected&&((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN}getPlayerNumber(){return this.playerNumber}}const me=({winner:l,loser:s,currentPlayerId:e,onRestart:t,onClose:g})=>{var _,C,E,N,G,k,y;const o=(l==null?void 0:l.id)===e,f=(l==null?void 0:l.score)===(s==null?void 0:s.score),[b,v]=c.useState(0),n=o?l:s,x=m=>m?m.startsWith("http")?m:`https://localhost${m}`:"/assets/images/default-avatar.png",I=x(n==null?void 0:n.profile_picture),j=x((_=n==null?void 0:n.badge)==null?void 0:_.image);return c.useEffect(()=>{const m=setTimeout(()=>{var w;v(((w=n==null?void 0:n.badge)==null?void 0:w.progress_percentage)||0)},500);return()=>clearTimeout(m)},[(C=n==null?void 0:n.badge)==null?void 0:C.progress_percentage]),a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 z-10"}),a.jsxs("div",{className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 lp:px-10 px-5 z-20 
			flex flex-col justify-center text-center gameoverpopup`,children:[a.jsx("h1",{className:`font-dreamscape text-6xl tracking-wider ${f?"text-yellow-400 drop-shadow-[0_2px_10px_rgba(250,204,21,0.8)]":o?"text-online drop-shadow-[0_2px_10px_rgba(70,233,210,0.8)]":"text-defeat drop-shadow-[0_2px_10px_rgba(245,78,98,0.8)]"}`,children:f?"IT'S A DRAW":o?"YOU WON":"YOU LOST"}),a.jsxs("div",{className:"flex flex-col gap-2",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("img",{src:I,alt:n==null?void 0:n.username,className:"rounded-full ring-1 ring-primary aspect-square object-cover",onError:m=>{m.target.src="/assets/images/default-avatar.png"}}),a.jsxs("div",{className:"flex flex-col items-start",children:[a.jsx("h2",{className:"font-heavy text-primary",children:n==null?void 0:n.username}),a.jsx("p",{className:"achievement-name font-dreamscape-sans text-level",children:(E=n==null?void 0:n.badge)==null?void 0:E.name}),a.jsxs("p",{className:"achievement-name font-heavy text-light leading-none",children:["Score: ",n==null?void 0:n.score]})]})]}),a.jsxs("div",{className:"bg-border bg-opacity-20 rounded p-4",children:[a.jsx("h3",{className:"text-primary font-heavy text-start mb-4",children:"Your Experience Update"}),a.jsxs("div",{className:"ml-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"Previous XP"}),a.jsx("span",{className:"text-primary",children:n==null?void 0:n.old_xp})]}),a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"XP Change"}),a.jsx("span",{className:`${f?"text-yellow-400":o?"text-online":"text-defeat"}`,children:(n==null?void 0:n.xp_change)>=0?`+${n==null?void 0:n.xp_change}`:n==null?void 0:n.xp_change})]}),a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"New XP"}),a.jsx("span",{className:"text-primary",children:n==null?void 0:n.new_xp})]})]})]}),a.jsxs("div",{className:"bg-border bg-opacity-20 rounded p-4",children:[a.jsx("h3",{className:"text-primary font-heavy mb-4 text-start",children:"Current Achievement"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{children:a.jsx("img",{src:j,alt:(N=n==null?void 0:n.badge)==null?void 0:N.name,className:"object-contain hover:scale-105 transition duration-500",onError:m=>{m.target.style.display="none"}})}),a.jsxs("div",{className:"flex-1 flex flex-col",children:[a.jsx("p",{className:"font-dreamscape-sans text-xl text-level mb-2",children:(G=n==null?void 0:n.badge)==null?void 0:G.name}),a.jsxs("div",{className:"flex justify-between text-sm text-primary font-medium",children:[a.jsxs("span",{children:[(k=n==null?void 0:n.badge)==null?void 0:k.current_threshold,"xp"]}),a.jsxs("span",{children:[(y=n==null?void 0:n.badge)==null?void 0:y.next_threshold,"xp"]})]}),a.jsx("div",{className:"h-2 rounded-md bg-[rgb(121,118,110,0.7)] mt-1 flex items-center overflow-hidden",children:a.jsx("div",{className:"rounded-lg h-full bg-level transition-all duration-1000 ease-out",style:{width:`${b}%`}})})]})]})]}),a.jsxs("div",{className:"w-full flex justify-between mb-5 lg:gap-10 gap-6",children:[a.jsx("button",{onClick:t,className:`font-dreamscape bg-primary text-secondary py-3 flex-1 rounded
								hover:scale-[1.03] transition-all duration-300 ease-in-out`,children:"Play Again"}),a.jsx("button",{onClick:g,className:`font-heavy text-primary py-3 border border-border rounded flex-1
								bg-[rgb(183,170,156,12%)] transition-all duration-300 ease-in-out hover:bg-[rgb(183,170,156,30%)]`,children:"Return to Home"})]})]})]})]})},xe=()=>{var q,F,z,X;const l=se(),s=te(),e=c.useRef(null),{triggerAlert:t}=ae(),{gameId:g,playerNumber:o,opponent:f,currentUser:b,backgroundId:v}=s.state||{};if(c.useEffect(()=>{(!g||!o||!f||!b||!v)&&l("/dashboard",{replace:!0})},[g,o,f,b,v,l]),!g||!o||!f||!b||!v)return a.jsx(ne,{});const n=b,x=f,[I,j]=c.useState(0),[_,C]=c.useState(0),[E,N]=c.useState(!1),[G,k]=c.useState(null),[y,m]=c.useState(!1),[w,p]=c.useState(!1),[P,R]=c.useState(!1),[A,U]=c.useState(!1),[i,d]=c.useState(null),[u,T]=c.useState(null),[D,W]=c.useState(120),[$,S]=c.useState(null),[L,M]=c.useState({1:3,2:3});c.useEffect(()=>{const h=new he;return e.current=h,h.connect(g,o,b.id),h.on("game_info",r=>{k(r.state),setTimeout(()=>K(),1e3),setTimeout(()=>B(),1e3),B()}),h.on("game_state_update",r=>{k(O=>({...O,ball:r.state.ball,player1:r.state.player1,player2:r.state.player2,time_remaining:r.state.time_remaining,player1_score:r.state.player1.score,player2_score:r.state.player2.score})),W(r.state.time_remaining),o===1?(j(r.state.player1.score),C(r.state.player2.score)):(j(r.state.player2.score),C(r.state.player1.score)),r.state.winner&&d(r.state.winner)}),h.on("game_paused",r=>{m(!0),S(r.player),M(r.pauses_remaining)}),h.on("game_resumed",()=>{m(!1),S(null)}),h.on("game_started",()=>m(!1)),h.on("game_ended",r=>{p(!0),R(!0);const O={username:r.winner_user.username,id:r.winner_user.id,old_xp:r.winner_user.old_xp,new_xp:r.winner_user.new_xp,xp_change:r.winner_user.xp_change,score:r.winner_user.score,badge:r.winner_user.badge,profile_picture:r.winner_user.profile_picture};d(O);const Z={username:r.loser_user.username,id:r.loser_user.id,old_xp:r.loser_user.old_xp,new_xp:r.loser_user.new_xp,xp_change:r.loser_user.xp_change,score:r.loser_user.score,badge:r.loser_user.badge,profile_picture:r.loser_user.profile_picture};T(Z),U(!0),setTimeout(()=>U(!1),5e3)}),h.on("player_quit",r=>{p(!0),d(b),T(f),R(!0)}),h.on("player_temporary_disconnect",r=>{r.player!==o&&(N(!0),m(!0))}),h.on("player_reconnected",r=>{r.player!==o&&(N(!1),m(!1))}),()=>h.disconnect()},[g]),c.useEffect(()=>{const h=setTimeout(()=>{var r;(r=e.current)==null||r.send({type:"check_ready_players"})},11e3);return e.current&&e.current.on("ready_players_count",r=>{r.ready_count===1&&(t("error","Opponent did not join the game"),l("/dashboard"))}),()=>{clearTimeout(h),e.current&&e.current.off("ready_players_count")}},[]);const Y=h=>{var r;(r=e.current)==null||r.sendPaddleMove(h)},J=()=>{!e.current||!o||w||!y&&L[o]<=0||y&&$!==o||e.current.send({type:y?"resume_game":"pause_game"})},K=()=>{var h;(h=e.current)==null||h.send({type:"player_ready"})},B=()=>{var h;(h=e.current)==null||h.send({type:"start_game"})},V=()=>{R(!1),l("/dashboard")},Q=()=>{!e.current||!o||(R(!1),l("/custom"))};return a.jsxs(a.Fragment,{children:[a.jsxs("section",{className:`relative flex-1 margin-page flex flex-col items-center gap-8 ${y?"bg-backdrop-40":""}`,children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"flex justify-center gap-4"}),a.jsx(re,{player1Score:_,player2Score:I,isPaused:y}),a.jsx(ie,{isPaused:y,timeRemaining:D})]}),a.jsxs("div",{className:"relative w-full flex justify-center items-center font-dreamscape-sans matchmaking",children:[a.jsx(H,{id:1,isPaused:y,PlayerName:x.username,BadgeName:(q=x.badge)==null?void 0:q.name,playerImage:x.profile_picture,badgeImage:(F=x.badge)==null?void 0:F.image}),a.jsx(H,{id:2,isPaused:y,PlayerName:n.username,BadgeName:(z=n.badge)==null?void 0:z.name,playerImage:n.profile_picture,badgeImage:(X=n.badge)==null?void 0:X.image}),a.jsx(ce,{gameState:G,onPaddleMove:Y,playerNumber:o,isPaused:y,handlePause:J,backgroundId:v,isGameOver:w,pausesRemaining:L,pausingPlayer:$,opponentDisconnected:E})]})]}),P&&a.jsx(me,{winner:i,loser:u,currentPlayerId:b.id,onRestart:Q,onClose:V}),i&&A&&a.jsx(le,{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:20},recycle:!1,numberOfPieces:500})]})};export{xe as default};
