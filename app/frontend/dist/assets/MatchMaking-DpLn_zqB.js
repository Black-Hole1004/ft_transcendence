import{r as m,j as e,u as E,c as C}from"./index-B4bz0GvT.js";/* empty css                    */import U from"./SearchingAnimation-BebmIuok.js";import{B as P}from"./Button-DzeJS1SW.js";const O="https://localhost";class F{constructor(){this.socket=null,this.callbacks={},this.handleMessage=this.handleMessage.bind(this),this.currentUserId=null}isConnected(){var t;return((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN}close(){var t;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN&&this.socket.close(1e3,"Normal closure")}connect(t){this.currentUserId=t,this.socket&&this.socket.close();const a=O.replace("https://","");this.socket=new WebSocket(`wss://${a}/ws/matchmaking/?user_id=${t}`),this.socket.onopen=()=>{var r,n;console.log("Connected to matchmaking service"),(n=(r=this.callbacks).onConnect)==null||n.call(r)},this.socket.onmessage=this.handleMessage,this.socket.onclose=()=>{var r,n;console.log("Disconnected from matchmaking service"),(n=(r=this.callbacks).onDisconnect)==null||n.call(r),this.currentUserId=null},this.socket.onerror=r=>console.error("Matchmaking error:",r)}handleMessage(t){var a,r,n,c,d,u,o,v,f,j,h,y,b,x,N,g,p,S;try{const i=JSON.parse(t.data);switch(console.log("Received message:",i),i.type){case"status":(r=(a=this.callbacks).onStatus)==null||r.call(a,i);break;case"searching":(c=(n=this.callbacks).onSearching)==null||c.call(n,i);break;case"match_found":(u=(d=this.callbacks).onMatchFound)==null||u.call(d,i);break;case"direct_match":(v=(o=this.callbacks).onDirectMatch)==null||v.call(o,i);break;case"cancelled":(j=(f=this.callbacks).onCancelled)==null||j.call(f,i);break;case"timeout":(y=(h=this.callbacks).onTimeout)==null||y.call(h,i);break;case"error":i.message.includes("already in a game")?(x=(b=this.callbacks).onInGame)==null||x.call(b,i):i.message.includes("Already searching")?(g=(N=this.callbacks).onAlreadySearching)==null||g.call(N,i):(S=(p=this.callbacks).onError)==null||S.call(p,i);break}}catch(i){console.error("Error handling message:",i)}}findMatch(){this.send({type:"find_match",user_id:this.currentUserId})}initiateDirectMatch(t,a){this.send({type:"direct_match",invitation_id:t,current_user_id:a})}cancelSearch(){this.send({type:"cancel_match",user_id:this.currentUserId})}send(t){var a,r,n;((a=this.socket)==null?void 0:a.readyState)===WebSocket.OPEN?this.socket.send(JSON.stringify(t)):(console.error("Socket is not open"),(n=(r=this.callbacks).onError)==null||n.call(r,{type:"error",message:"Connection lost. Please refresh the page."}))}on(t,a){switch(t){case"connect":this.callbacks.onConnect=a;break;case"disconnect":this.callbacks.onDisconnect=a;break;case"searching":this.callbacks.onSearching=a;break;case"match_found":this.callbacks.onMatchFound=a;break;case"direct_match":this.callbacks.onDirectMatch=a;break;case"cancelled":this.callbacks.onCancelled=a;break;case"error":this.callbacks.onError=a;break;case"timeout":this.callbacks.onTimeout=a;break;case"status":this.callbacks.onStatus=a;break;case"inGame":this.callbacks.onInGame=a;break;case"alreadySearching":this.callbacks.onAlreadySearching=a;break}}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}}const G=({matchData:l,countdown:t,statement:a})=>{if(m.useState(!1),!(l!=null&&l.current_user)||!(l!=null&&l.opponent))return e.jsx("div",{className:"text-primary",children:"Loading match data..."});const r=l.current_user,n=l.opponent,c=(d,u="profile")=>d?d.startsWith("http")?d:`https://localhost${d}`:"/assets/images/default-avatar.png";return e.jsxs("section",{className:"flex justify-center",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-10"}),e.jsxs("div",{className:"absolute top-[44%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20",children:[e.jsx("h1",{className:"statement text-[80%] text-center font-dreamscape text-light mb-32",children:a}),e.jsxs("div",{className:"matchmaking flex justify-center items-center",children:[e.jsxs("div",{className:"avatar flex flex-col items-center xl:gap-12 lg:gap-10 tb:gap-5 gap-3",children:[e.jsxs("div",{className:"relative rounded-full border border-primary",children:[e.jsx("img",{src:c(r.profile_picture,"profile"),alt:r.username,className:"match-user-image aspect-square object-cover rounded-full",onError:d=>{console.log("Profile image load error:",d),d.target.src="/assets/images/default-avatar.png"}}),r.badge&&e.jsx("img",{src:c(r.badge.image,"badge"),alt:r.badge.name,className:"absolute z-10 bottom-0 -left-5 w-[60%]"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:r.username}),e.jsx("h6",{className:"font-dreamscape-sans text-level",children:r.badge.name})]})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("h1",{className:"font-dreamscape text-primary",children:"VS"}),t?e.jsx("div",{className:"countdown text-9xl font-bold text-light animate-pulse",children:t}):e.jsx(e.Fragment,{})]}),e.jsxs("div",{className:"avatar flex flex-col items-center  lg:gap-10 tb:gap-5 gap-3",children:[e.jsxs("div",{className:"relative rounded-full border border-primary",children:[e.jsx("img",{src:c(n.profile_picture,"profile"),alt:n.username,className:"match-user-image aspect-square object-cover rounded-full",onError:d=>{console.log("Profile image load error:",d),d.target.src="/assets/images/default-avatar.png"}}),n.badge&&e.jsx("img",{src:c(n.badge.image,"badge"),alt:n.badge.name,className:"absolute z-10 bottom-0 -right-5 w-[60%]"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:n.username}),e.jsx("h6",{className:"font-dreamscape-sans text-level",children:n.badge.name})]})]})]})]})]})},W=()=>{const l=E(),t=C(),[a,r]=m.useState(!1),[n,c]=m.useState("connecting"),[d,u]=m.useState(null),[o]=m.useState(new F),[v,f]=m.useState(5),[j,h]=m.useState(""),[y,b]=m.useState("");m.useEffect(()=>{var w,M,I;const g=(w=t.state)==null?void 0:w.currentUser,p=g==null?void 0:g.id,S=(M=t.state)==null?void 0:M.isDirectMatch,i=(I=t.state)==null?void 0:I.invitationId;if(!g||!p){console.error("No user data available. Redirecting to dashboard..."),l("/dashboard",{replace:!0});return}return o.isConnected()&&o.disconnect(),u(null),c("connecting"),o.cancelSearch(),o.connect(p),o.on("connect",()=>{c("connected"),S?(o.initiateDirectMatch(i,p),c("waiting for opponent")):(o.findMatch(),c("searching"))}),o.on("error",s=>{console.error("Matchmaking error:",s),c("error"),h(s.message)}),o.on("inGame",s=>{c("inGame"),h(s.message)}),o.on("alreadySearching",s=>{c("searching"),h(s.message)}),o.on("timeout",s=>{c("timeout")}),o.on("searching",s=>{c("searching")}),o.on("match_found",async s=>{var k;if(c("match_found"),b("match found"),r(!0),u(s),!s.game_id){console.error("Server did not provide game_id"),c("error"),h("Invalid game data received");return}if(s.countdown!==void 0&&f(s.countdown),s.should_navigate){const _=((k=t.state)==null?void 0:k.backgroundId)||3;setTimeout(()=>{l("/remote-game",{state:{playerNumber:s.player_number,gameId:s.game_id,opponent:s.opponent,currentUser:s.current_user,backgroundId:_}})},1e3)}}),o.on("direct_match",async s=>{var k;if(c("match_found"),b("Friendly Match"),r(!0),u(s),!s.game_id){console.error("Server did not provide game_id"),c("error"),h("Invalid game data received");return}if(s.countdown!==void 0&&f(s.countdown),s.should_navigate){const _=((k=t.state)==null?void 0:k.backgroundId)||3;l("/remote-game",{state:{playerNumber:s.player_number,gameId:s.game_id,opponent:s.opponent,currentUser:s.current_user,backgroundId:_}})}}),()=>{o.disconnect()}},[t.state]);const x=()=>{o.cancelSearch(),l("/custom")},N=()=>{switch(n){case"other_tab_active":return e.jsxs("div",{className:"w-full flex flex-col items-center gap-8 bg-backdrop-80 p-12 rounded-lg shadow-xl",children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Matchmaking In Progress"}),e.jsx("p",{children:"This game is being handled in another tab"}),e.jsx("p",{children:"Please switch to that tab or close this one"}),e.jsx("button",{onClick:x,className:"px-8 py-3 bg-primary text-backdrop-80 rounded-lg",children:"Back to Menu"})]});case"match_found":return e.jsx(G,{matchData:d,countdown:v,statement:y});case"timeout":return e.jsxs("div",{className:`w-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
                    flex flex-col items-center gap-8 text-center z-20 timeout`,children:[e.jsx("h2",{className:"players-usernames font-heavy",children:"Time Out"}),e.jsx("p",{className:"font-medium",children:"No opponent found at the moment, Please try again later."}),e.jsx(P,{onClick:()=>l("/custom"),className:"py-3 px-6 rounded border border-border font-medium buttons-text remove-button",children:"Back to Menu"})]});case"error":case"inGame":return e.jsx("div",{className:"w-1/3 min-w-[400px]",children:e.jsxs("div",{className:"w-full flex flex-col items-center gap-8 bg-backdrop-80 p-12 rounded-lg shadow-xl",children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Error"}),e.jsx("p",{children:j}),e.jsx("button",{onClick:()=>l("/custom"),className:"px-8 py-3 bg-primary text-backdrop-80 rounded-lg hover:bg-opacity-90 transition-all font-bold",children:"Go Back"})]})});default:return e.jsx("div",{className:"w-1/3 min-w-[400px] flex flex-col items-center",children:e.jsx("div",{className:"flex-grow flex items-center justify-center relative",children:n==="searching"?e.jsx(U,{opponentFound:a,handleCancel:x}):null})})}};return e.jsxs("section",{className:"flex justify-center flex-1",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-10"}),N()]})};export{W as default};
