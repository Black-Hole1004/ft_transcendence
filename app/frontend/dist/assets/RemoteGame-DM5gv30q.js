import{R as Z,r as o,j as a,u as ee,c as se,L as te}from"./index-B4bz0GvT.js";/* empty css             */import{G as ae,T as ne}from"./GameScore-BsyvPK8C.js";/* empty css                    */import{C as re}from"./react-confetti.min-BUK6BsUL.js";const ie=l=>{const s=o.useCallback((c,g="profile")=>c?c.startsWith("http")||c.startsWith("/assets")?c:`https://localhost${c}`:"/assets/images/default-avatar.png",[]),e=o.useMemo(()=>s(l.playerImage,"profile"),[l.playerImage,s]),t=o.useMemo(()=>s(l.badgeImage,"badge"),[l.badgeImage,s]),h=o.useMemo(()=>l.PlayerName.length>11?l.PlayerName.slice(0,11)+"...":l.PlayerName,[l.PlayerName]);return a.jsxs("div",{className:`${l.id===1?"mtb:left-0 left-3":"mtb:right-0 right-3"} max-lg:-bottom-10 max-lg:top-full
			absolute flex flex-col items-center ${l.isPaused?"brightness-[20%]":"brightness-[1]"}
			avatar aspect-square xl:gap-12 lg:gap-10 tb:gap-5 gap-3`,children:[a.jsxs("div",{className:"relative rounded-full border border-primary",children:[a.jsx("img",{src:e,alt:"user photo",className:"match-user-image aspect-square object-cover rounded-full",onError:c=>{console.log("Profile image load error:",c),c.target.src="/assets/images/default-avatar.png"}}),a.jsx("img",{src:t,alt:"badge",className:`absolute z-10 bottom-0 ${l.id===1?"-left-5":"-right-5"} w-[60%]`})]}),a.jsxs("div",{children:[a.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:h}),a.jsx("h6",{className:"font-dreamscape-sans text-level",children:l.BadgeName})]})]})},X=Z.memo(ie),le=({gameState:l,onPaddleMove:s,playerNumber:e,isPaused:t,handlePause:h,isGameOver:c,pausesRemaining:g,pausingPlayer:y,backgroundId:v,opponentDisconnected:n})=>{const w=o.useRef(null),E=o.useRef(null),N=o.useRef(null),[x,D]=o.useState({width:800,height:400}),k=1200,[C,T]=o.useState(!1),[b,j]=o.useState(!1);return o.useEffect(()=>{if(!l||!w.current)return;w.current.getContext("2d");const _=i=>{i.clearRect(0,0,x.width,x.height)},f=(i,d,m,R)=>{i.shadowBlur=0,i.shadowColor=R,i.fillStyle=R,i.beginPath(),i.moveTo(d+8.6,m),i.lineTo(d+16-8.6,m),i.quadraticCurveTo(d+16,m,d+16,m+8.6),i.lineTo(d+16,m+80-8.6),i.quadraticCurveTo(d+16,m+80,d+16-8.6,m+80),i.lineTo(d+8.6,m+80),i.quadraticCurveTo(d,m+80,d,m+80-8.6),i.lineTo(d,m+8.6),i.quadraticCurveTo(d,m,d+8.6,m),i.closePath(),i.fill(),i.shadowBlur=0},I=(i,d)=>{if(!d)return;i.shadowBlur=0,i.shadowColor="white",i.beginPath();const m=e===2?x.width-d.x:d.x;i.arc(m,d.y,10,0,Math.PI*2),i.fillStyle="white",i.fill(),i.closePath(),i.shadowBlur=0},$=(i,d,m)=>{if(!d.player1||!d.player2)return;const R=x.width-16-5,A=5;m===1?(f(i,R,d.player1.y,"white"),f(i,A,d.player2.y,"white")):(f(i,R,d.player2.y,"white"),f(i,A,d.player1.y,"white"))},G=()=>{if(!l||!w.current)return;const i=w.current.getContext("2d");_(i),I(i,l.ball),$(i,l,e)},U=()=>{G(),N.current=requestAnimationFrame(U)};return U(),()=>{N.current&&cancelAnimationFrame(N.current)}},[l,x.width,x.height]),o.useEffect(()=>{const p=f=>{f.key==="ArrowUp"&&(f.preventDefault(),s("startUp")),f.key==="ArrowDown"&&(f.preventDefault(),s("startDown"))},_=f=>{f.key==="ArrowUp"&&(f.preventDefault(),s("stopUp")),f.key==="ArrowDown"&&(f.preventDefault(),s("stopDown"))};return window.addEventListener("keydown",p),window.addEventListener("keyup",_),()=>{window.removeEventListener("keydown",p),window.removeEventListener("keyup",_)}},[s]),o.useEffect(()=>{if(!l||t)return;const _=setInterval(()=>{C&&s("up"),b&&s("down")},16);return()=>clearInterval(_)},[t,C,b,s]),a.jsxs("div",{ref:E,className:"relative flex flex-col items-center lp:gap-7 gap-3 max-lp:w-full",children:[a.jsx("canvas",{ref:w,width:x.width,height:x.height,className:`game-table aspect-video border ${t?"brightness-[20%]":"brightness-[1]"}`,style:{borderRadius:"25px",width:"100%",height:"auto",maxWidth:`${k}px`,backgroundSize:"cover",backgroundPosition:"center",backgroundImage:`url('/assets/images/tables/table${v}.${v>6?"gif":"webp"}')`}}),t&&a.jsx("div",{children:a.jsx("p",{className:`text-[100px] font-dreamscape text-center leading-[1.01] game-paused
					absolute transform top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2`,children:n?"OPPONENT DISCONNECTED...":"GAME PAUSED"})}),!c&&a.jsxs("button",{onClick:h,disabled:!t&&g[e]<=0||t&&y!==e,className:`pause flex items-center gap-3 brightness-[1] leading-[0.95] ${!t&&g[e]<=0||t&&y!==e?"opacity-50 cursor-not-allowed":""}`,children:[a.jsx("img",{src:`/assets/images/icons/${t?"play":"pause"}.svg`,alt:""}),a.jsx("p",{className:"align-middle",children:t?"resume":`pause (${g[e]} left)`})]})]})},oe="https://localhost";class ce{constructor(){this.socket=null,this.callbacks={},this.isConnected=!1,this.connectionAttempts=0,this.maxRetries=1,this.reconnectTimeout=null,this.gameId=null,this.userId=null,this.playerNumber=null}connect(s,e,t){if(!s||!t){console.error("No game ID or user ID provided");return}this.gameId=s,this.playerNumber=e,this.userId=t;const h=oe.replace("https://","");this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null);try{const c=`wss://${h}/ws/game/${s}/`;this.socket&&(this.socket.close(),this.socket=null),this.socket=new WebSocket(c),this.setupEventHandlers()}catch(c){console.error("Error creating WebSocket:",c),this.handleError(c)}}sendPlayerNumber(){this.send({type:"player_number_init",player_number:this.playerNumber,player_id:this.userId})}handlePlayerNumberConfirmed(s){var e,t;(t=(e=this.callbacks).player_number_confirmed)==null||t.call(e,s)}setupEventHandlers(){this.socket.onopen=this.handleOpen.bind(this),this.socket.onclose=this.handleClose.bind(this),this.socket.onerror=this.handleError.bind(this),this.socket.onmessage=this.handleMessage.bind(this)}handleOpen(){var s,e;console.log(`Connected to game ${this.gameId} through WebSocket successfully`),this.isConnected=!0,this.connectionAttempts=0,(e=(s=this.callbacks).connect)==null||e.call(s),this.sendPlayerNumber()}handleClose(s){var e,t;this.isConnected=!1,console.log(`Disconnected from game ${this.gameId}`,{wasClean:s.wasClean,code:s.code,reason:s.reason,connectionAttempts:this.connectionAttempts}),!s.wasClean&&this.connectionAttempts<this.maxRetries?(console.log(`Attempting reconnect ${this.connectionAttempts+1}/${this.maxRetries}`),this.connectionAttempts++,this.reconnectTimeout=setTimeout(()=>this.connect(this.gameId),1e3)):(console.log("Not attempting reconnect:",{wasClean:s.wasClean,maxRetriesReached:this.connectionAttempts>=this.maxRetries}),(t=(e=this.callbacks).disconnect)==null||t.call(e))}handleError(s){var e,t;console.error(`WebSocket error for game ${this.gameId}:`,s),(t=(e=this.callbacks).error)==null||t.call(e,s)}handleMessage(s){try{const e=JSON.parse(s.data);e.type==="game_info"&&(this.playerNumber=e.player_number);const h={game_info:this.handleGameInfo.bind(this),player_number_confirmed:this.handlePlayerNumberConfirmed.bind(this),game_state_update:this.handleGameStateUpdate.bind(this),paddles_update:this.handlePaddlesUpdate.bind(this),ball_update:this.handleBallUpdate.bind(this),score_update:this.handleScoreUpdate.bind(this),game_ended:this.handleGameEnded.bind(this),game_started:this.handleGameStarted.bind(this),game_paused:this.handleGamePaused.bind(this),game_resumed:this.handleGameResumed.bind(this),pause_timeout_warning:this.handlePauseTimeoutWarning.bind(this),player_temporary_disconnect:this.handleTemporaryDisconnect.bind(this),player_reconnected:this.handlePlayerReconnected.bind(this),game_restarted:this.handleGameRestarted.bind(this),player_disconnected:this.handlePlayerDisconnected.bind(this),waiting_for_player:this.handleWaitingForPlayer.bind(this),error:this.handleServerError.bind(this)}[e.type];h?h(e):console.warn("Unknown message type:",e.type)}catch(e){console.error("Error handling message:",e),this.handleError(e)}}handleGameInfo(s){var e,t;(t=(e=this.callbacks).game_info)==null||t.call(e,s)}handleGameStateUpdate(s){var e,t;(t=(e=this.callbacks).game_state_update)==null||t.call(e,s)}handlePaddlesUpdate(s){var e,t;(t=(e=this.callbacks).paddles_update)==null||t.call(e,s)}handleBallUpdate(s){var e,t;(t=(e=this.callbacks).ball_update)==null||t.call(e,s)}handleScoreUpdate(s){var e,t;(t=(e=this.callbacks).score_update)==null||t.call(e,s)}handleGameEnded(s){var e,t;(t=(e=this.callbacks).game_ended)==null||t.call(e,s)}handleGameStarted(s){var e,t;(t=(e=this.callbacks).game_started)==null||t.call(e,s)}handleGamePaused(s){var e,t;(t=(e=this.callbacks).game_paused)==null||t.call(e,s)}handleGameResumed(s){var e,t;(t=(e=this.callbacks).game_resumed)==null||t.call(e,s)}handleGameRestarted(s){var e,t;(t=(e=this.callbacks).game_restarted)==null||t.call(e,s)}handlePlayerDisconnected(s){var e,t;(t=(e=this.callbacks).player_disconnected)==null||t.call(e,s)}handleWaitingForPlayer(s){var e,t;(t=(e=this.callbacks).waiting_for_player)==null||t.call(e,s)}handleServerError(s){var e,t;(t=(e=this.callbacks).error)==null||t.call(e,new Error(s.message))}handlePauseTimeoutWarning(s){var e,t;(t=(e=this.callbacks).pause_timeout_warning)==null||t.call(e,s)}handleTemporaryDisconnect(s){var e,t;(t=(e=this.callbacks).player_temporary_disconnect)==null||t.call(e,s)}handlePlayerReconnected(s){var e,t;(t=(e=this.callbacks).player_reconnected)==null||t.call(e,s)}send(s){if(!this.isSocketConnected()){console.error("Cannot send message: socket is not connected");return}try{this.socket.send(JSON.stringify(s))}catch(e){console.error("Error sending message:",e),this.handleError(e)}}sendPaddleMove(s){this.send({type:"paddle_direction",action:s})}sendPlayerReady(){console.log("Sending player ready"),this.send({type:"player_ready"})}sendStartGame(){console.log("Sending start game"),this.send({type:"start_game"})}sendRestartGame(){console.log("Sending restart game"),this.send({type:"restart_game"})}on(s,e){if(typeof e!="function"){console.error("Callback must be a function");return}console.log("Registering callback for event:",s),this.callbacks[s]=e}disconnect(){console.log("Disconnecting WebSocket"),this.maxRetries=0,this.reconnectTimeout&&(clearTimeout(this.reconnectTimeout),this.reconnectTimeout=null),this.socket&&(this.isConnected=!1,this.socket.close(),this.socket=null)}isSocketConnected(){var s;return this.isConnected&&((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN}getPlayerNumber(){return this.playerNumber}}const de=({winner:l,loser:s,currentPlayerId:e,onRestart:t,onClose:h})=>{var x,D,k,C,T,b,j;const c=(l==null?void 0:l.id)===e,g=(l==null?void 0:l.score)===(s==null?void 0:s.score),[y,v]=o.useState(0),n=c?l:s,w=p=>p?p.startsWith("http")?p:`https://localhost${p}`:"/assets/images/default-avatar.png",E=w(n==null?void 0:n.profile_picture),N=w((x=n==null?void 0:n.badge)==null?void 0:x.image);return o.useEffect(()=>{const p=setTimeout(()=>{var _;v(((_=n==null?void 0:n.badge)==null?void 0:_.progress_percentage)||0)},500);return()=>clearTimeout(p)},[(D=n==null?void 0:n.badge)==null?void 0:D.progress_percentage]),a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-90 z-10"}),a.jsxs("div",{className:`absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 lp:px-10 px-5 z-20 
			flex flex-col justify-center text-center gameoverpopup`,children:[a.jsx("h1",{className:`font-dreamscape text-6xl tracking-wider ${g?"text-yellow-400 drop-shadow-[0_2px_10px_rgba(250,204,21,0.8)]":c?"text-online drop-shadow-[0_2px_10px_rgba(70,233,210,0.8)]":"text-defeat drop-shadow-[0_2px_10px_rgba(245,78,98,0.8)]"}`,children:g?"IT'S A DRAW":c?"YOU WON":"YOU LOST"}),a.jsxs("div",{className:"flex flex-col gap-2",children:[a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("img",{src:E,alt:n==null?void 0:n.username,className:"rounded-full ring-1 ring-primary aspect-square object-cover",onError:p=>{p.target.src="/assets/images/default-avatar.png"}}),a.jsxs("div",{className:"flex flex-col items-start",children:[a.jsx("h2",{className:"font-heavy text-primary",children:n==null?void 0:n.username}),a.jsx("p",{className:"achievement-name font-dreamscape-sans text-level",children:(k=n==null?void 0:n.badge)==null?void 0:k.name}),a.jsxs("p",{className:"achievement-name font-heavy text-light leading-none",children:["Score: ",n==null?void 0:n.score]})]})]}),a.jsxs("div",{className:"bg-border bg-opacity-20 rounded p-4",children:[a.jsx("h3",{className:"text-primary font-heavy text-start mb-4",children:"Your Experience Update"}),a.jsxs("div",{className:"ml-2",children:[a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"Previous XP"}),a.jsx("span",{className:"text-primary",children:n==null?void 0:n.old_xp})]}),a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"XP Change"}),a.jsx("span",{className:`${g?"text-yellow-400":c?"text-online":"text-defeat"}`,children:(n==null?void 0:n.xp_change)>=0?`+${n==null?void 0:n.xp_change}`:n==null?void 0:n.xp_change})]}),a.jsxs("div",{className:"flex items-center justify-between text-lg font-medium leading-normal",children:[a.jsx("span",{className:"text-light",children:"New XP"}),a.jsx("span",{className:"text-primary",children:n==null?void 0:n.new_xp})]})]})]}),a.jsxs("div",{className:"bg-border bg-opacity-20 rounded p-4",children:[a.jsx("h3",{className:"text-primary font-heavy mb-4 text-start",children:"Current Achievement"}),a.jsxs("div",{className:"flex items-center gap-4",children:[a.jsx("div",{children:a.jsx("img",{src:N,alt:(C=n==null?void 0:n.badge)==null?void 0:C.name,className:"object-contain hover:scale-105 transition duration-500",onError:p=>{p.target.style.display="none"}})}),a.jsxs("div",{className:"flex-1 flex flex-col",children:[a.jsx("p",{className:"font-dreamscape-sans text-xl text-level mb-2",children:(T=n==null?void 0:n.badge)==null?void 0:T.name}),a.jsxs("div",{className:"flex justify-between text-sm text-primary font-medium",children:[a.jsxs("span",{children:[(b=n==null?void 0:n.badge)==null?void 0:b.current_threshold,"xp"]}),a.jsxs("span",{children:[(j=n==null?void 0:n.badge)==null?void 0:j.next_threshold,"xp"]})]}),a.jsx("div",{className:"h-2 rounded-md bg-[rgb(121,118,110,0.7)] mt-1 flex items-center overflow-hidden",children:a.jsx("div",{className:"rounded-lg h-full bg-level transition-all duration-1000 ease-out",style:{width:`${y}%`}})})]})]})]}),a.jsxs("div",{className:"w-full flex justify-between mb-5 lg:gap-10 gap-6",children:[a.jsx("button",{onClick:t,className:`font-dreamscape bg-primary text-secondary py-3 flex-1 rounded
								hover:scale-[1.03] transition-all duration-300 ease-in-out`,children:"Play Again"}),a.jsx("button",{onClick:h,className:`font-heavy text-primary py-3 border border-border rounded flex-1
								bg-[rgb(183,170,156,12%)] transition-all duration-300 ease-in-out hover:bg-[rgb(183,170,156,30%)]`,children:"Return to Home"})]})]})]})]})},fe=()=>{var B,q,F,z;const l=ee(),s=se(),e=o.useRef(null),{gameId:t,playerNumber:h,opponent:c,currentUser:g,backgroundId:y}=s.state||{};if(o.useEffect(()=>{(!t||!h||!c||!g||!y)&&(console.log("Redirecting to dashboard..."),l("/dashboard",{replace:!0}))},[t,h,c,g,y,l]),!t||!h||!c||!g||!y)return a.jsx(te,{});const v=g,n=c,[w,E]=o.useState(0),[N,x]=o.useState(0),[D,k]=o.useState(!1),[C,T]=o.useState(null),[b,j]=o.useState(!1),[p,_]=o.useState(!1),[f,I]=o.useState(!1),[$,G]=o.useState(!1),[U,i]=o.useState(null),[d,m]=o.useState(null),[R,A]=o.useState(120),[P,S]=o.useState(null),[O,H]=o.useState({1:3,2:3});o.useEffect(()=>{const u=new ce;return e.current=u,u.connect(t,h,g.id),u.on("game_info",r=>{T(r.state),setTimeout(()=>J(),1e3),setTimeout(()=>L(),1e3),L()}),u.on("game_state_update",r=>{T(W=>({...W,ball:r.state.ball,player1:r.state.player1,player2:r.state.player2,time_remaining:r.state.time_remaining,player1_score:r.state.player1.score,player2_score:r.state.player2.score})),A(r.state.time_remaining),h===1?(E(r.state.player1.score),x(r.state.player2.score)):(E(r.state.player2.score),x(r.state.player1.score)),r.state.winner&&i(r.state.winner)}),u.on("game_paused",r=>{j(!0),S(r.player),H(r.pauses_remaining)}),u.on("game_resumed",()=>{j(!1),S(null)}),u.on("game_started",()=>j(!1)),u.on("game_ended",r=>{_(!0),I(!0);const W={username:r.winner_user.username,id:r.winner_user.id,old_xp:r.winner_user.old_xp,new_xp:r.winner_user.new_xp,xp_change:r.winner_user.xp_change,score:r.winner_user.score,badge:r.winner_user.badge,profile_picture:r.winner_user.profile_picture};i(W);const Q={username:r.loser_user.username,id:r.loser_user.id,old_xp:r.loser_user.old_xp,new_xp:r.loser_user.new_xp,xp_change:r.loser_user.xp_change,score:r.loser_user.score,badge:r.loser_user.badge,profile_picture:r.loser_user.profile_picture};m(Q),G(!0),setTimeout(()=>G(!1),5e3)}),u.on("player_quit",r=>{_(!0),i(g),m(c),I(!0)}),u.on("player_temporary_disconnect",r=>{r.player!==h&&(k(!0),j(!0))}),u.on("player_reconnected",r=>{r.player!==h&&(k(!1),j(!1))}),()=>u.disconnect()},[t]);const M=u=>{var r;(r=e.current)==null||r.sendPaddleMove(u)},Y=()=>{!e.current||!h||p||!b&&O[h]<=0||b&&P!==h||e.current.send({type:b?"resume_game":"pause_game"})},J=()=>{var u;(u=e.current)==null||u.send({type:"player_ready"})},L=()=>{var u;(u=e.current)==null||u.send({type:"start_game"})},K=()=>{I(!1),l("/dashboard")},V=()=>{!e.current||!h||(I(!1),l("/custom"))};return a.jsxs(a.Fragment,{children:[a.jsxs("section",{className:`relative flex-1 margin-page flex flex-col items-center gap-8 ${b?"bg-backdrop-40":""}`,children:[a.jsxs("div",{className:"flex flex-col",children:[a.jsx("div",{className:"flex justify-center gap-4"}),a.jsx(ae,{player1Score:N,player2Score:w,isPaused:b}),a.jsx(ne,{isPaused:b,timeRemaining:R})]}),a.jsxs("div",{className:"relative w-full flex justify-center items-center font-dreamscape-sans matchmaking",children:[a.jsx(X,{id:1,isPaused:b,PlayerName:n.username,BadgeName:(B=n.badge)==null?void 0:B.name,playerImage:n.profile_picture,badgeImage:(q=n.badge)==null?void 0:q.image}),a.jsx(X,{id:2,isPaused:b,PlayerName:v.username,BadgeName:(F=v.badge)==null?void 0:F.name,playerImage:v.profile_picture,badgeImage:(z=v.badge)==null?void 0:z.image}),a.jsx(le,{gameState:C,onPaddleMove:M,playerNumber:h,isPaused:b,handlePause:Y,backgroundId:y,isGameOver:p,pausesRemaining:O,pausingPlayer:P,opponentDisconnected:D})]})]}),f&&a.jsx(de,{winner:U,loser:d,currentPlayerId:g.id,onRestart:V,onClose:K}),U&&$&&a.jsx(re,{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",zIndex:20},recycle:!1,numberOfPieces:500})]})};export{fe as default};
