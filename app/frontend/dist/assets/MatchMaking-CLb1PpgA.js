import{r as h,j as e,u as C,c as U}from"./index-BAIcLLuA.js";/* empty css                    */import{B as E}from"./Button-CuXPXjAA.js";const G="https://localhost";class A{constructor(){this.socket=null,this.callbacks={},this.handleMessage=this.handleMessage.bind(this),this.currentUserId=null}isConnected(){var s;return((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN}close(){var s;((s=this.socket)==null?void 0:s.readyState)===WebSocket.OPEN&&this.socket.close(1e3,"Normal closure")}connect(s){this.currentUserId=s,this.socket&&this.socket.close();const t=G.replace("https://","");this.socket=new WebSocket(`wss://${t}/ws/matchmaking/?user_id=${s}`),this.socket.onopen=()=>{var n,r;(r=(n=this.callbacks).onConnect)==null||r.call(n)},this.socket.onmessage=this.handleMessage,this.socket.onclose=()=>{var n,r;(r=(n=this.callbacks).onDisconnect)==null||r.call(n),this.currentUserId=null},this.socket.onerror=n=>console.error("Matchmaking error:",n)}handleMessage(s){var t,n,r,c,d,g,o,j,b,v,u,y,f,x,N,m,p,S;try{const l=JSON.parse(s.data);switch(l.type){case"status":(n=(t=this.callbacks).onStatus)==null||n.call(t,l);break;case"searching":(c=(r=this.callbacks).onSearching)==null||c.call(r,l);break;case"match_found":(g=(d=this.callbacks).onMatchFound)==null||g.call(d,l);break;case"direct_match":(j=(o=this.callbacks).onDirectMatch)==null||j.call(o,l);break;case"cancelled":(v=(b=this.callbacks).onCancelled)==null||v.call(b,l);break;case"timeout":(y=(u=this.callbacks).onTimeout)==null||y.call(u,l);break;case"error":l.message.includes("already in a game")?(x=(f=this.callbacks).onInGame)==null||x.call(f,l):l.message.includes("Already searching")?(m=(N=this.callbacks).onAlreadySearching)==null||m.call(N,l):(S=(p=this.callbacks).onError)==null||S.call(p,l);break}}catch(l){console.error("Error handling message:",l)}}findMatch(){this.send({type:"find_match",user_id:this.currentUserId})}initiateDirectMatch(s,t){this.send({type:"direct_match",invitation_id:s,current_user_id:t})}cancelSearch(){this.send({type:"cancel_match",user_id:this.currentUserId})}send(s){var t,n,r;((t=this.socket)==null?void 0:t.readyState)===WebSocket.OPEN?this.socket.send(JSON.stringify(s)):(r=(n=this.callbacks).onError)==null||r.call(n,{type:"error",message:"Connection lost. Please refresh the page."})}on(s,t){switch(s){case"connect":this.callbacks.onConnect=t;break;case"disconnect":this.callbacks.onDisconnect=t;break;case"searching":this.callbacks.onSearching=t;break;case"match_found":this.callbacks.onMatchFound=t;break;case"direct_match":this.callbacks.onDirectMatch=t;break;case"cancelled":this.callbacks.onCancelled=t;break;case"error":this.callbacks.onError=t;break;case"timeout":this.callbacks.onTimeout=t;break;case"status":this.callbacks.onStatus=t;break;case"inGame":this.callbacks.onInGame=t;break;case"alreadySearching":this.callbacks.onAlreadySearching=t;break}}disconnect(){this.socket&&(this.socket.close(),this.socket=null)}}const O=({matchData:i,countdown:s,statement:t})=>{if(h.useState(!1),!(i!=null&&i.current_user)||!(i!=null&&i.opponent))return e.jsx("div",{className:"text-primary",children:"Loading match data..."});const n=i.current_user,r=i.opponent,c=(d,g="profile")=>d?d.startsWith("http")?d:`https://localhost${d}`:"/assets/images/avatar.jpg";return e.jsxs("section",{className:"flex justify-center",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-10"}),e.jsxs("div",{className:"absolute top-[44%] left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20",children:[e.jsx("h1",{className:"statement text-[80%] text-center font-dreamscape text-light mb-32",children:t}),e.jsxs("div",{className:"matchmaking flex justify-center items-center",children:[e.jsxs("div",{className:"avatar flex flex-col items-center xl:gap-12 lg:gap-10 tb:gap-5 gap-3",children:[e.jsxs("div",{className:"relative rounded-full border border-primary",children:[e.jsx("img",{src:c(n.profile_picture,"profile"),alt:n.username,className:"match-user-image aspect-square object-cover rounded-full",onError:d=>{d.target.src="/assets/images/avatar.jpg"}}),n.badge&&e.jsx("img",{src:c(n.badge.image,"badge"),alt:n.badge.name,className:"absolute z-10 bottom-0 -left-5 w-[60%]"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:n.username}),e.jsx("h6",{className:"font-dreamscape-sans text-level",children:n.badge.name})]})]}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("h1",{className:"font-dreamscape text-primary",children:"VS"}),s?e.jsx("div",{className:"countdown text-9xl font-bold text-light animate-pulse",children:s}):e.jsx(e.Fragment,{})]}),e.jsxs("div",{className:"avatar flex flex-col items-center  lg:gap-10 tb:gap-5 gap-3",children:[e.jsxs("div",{className:"relative rounded-full border border-primary",children:[e.jsx("img",{src:c(r.profile_picture,"profile"),alt:r.username,className:"match-user-image aspect-square object-cover rounded-full",onError:d=>{d.target.src="/assets/images/avatar.jpg"}}),r.badge&&e.jsx("img",{src:c(r.badge.image,"badge"),alt:r.badge.name,className:"absolute z-10 bottom-0 -right-5 w-[60%]"})]}),e.jsxs("div",{children:[e.jsx("h2",{className:"font-dreamscape-sans text-primary leading-none",children:r.username}),e.jsx("h6",{className:"font-dreamscape-sans text-level",children:r.badge.name})]})]})]})]})]})},$=({handleCancel:i,opponentFound:s})=>e.jsx(e.Fragment,{children:e.jsxs("div",{className:`animation-container absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2
				flex text-primary font-dreamscape select-none z-20`,children:[["S","E","A","R","C","H","I","N","G",".",".","."].map((t,n)=>e.jsx("marquee",{direction:"down",scrollamount:20+Math.ceil(Math.random()*10%10),style:{transitionDelay:`${n*50}ms`},className:`char ${t==="I"||t==="."?"marquee-sm":"marquee-lg"}
						searching-animation transition-opacity duration-300 ${s?"opacity-0":"opacity-100"}`,children:e.jsx("div",{children:t})},n)),e.jsx("div",{className:`animation-container absolute char searching-animation
						transition-opacity duration-1000 ${s?"opacity-100":"opacity-0"}`,children:"SEARCHING..."}),e.jsx(E,{className:`rounded border border-border font-medium cancel-button
						absolute left-1/2 top-full mt-10 transform -translate-x-1/2`,type:"submit",onClick:i,children:"Cancel"})]})}),P=()=>{const i=C(),s=U(),[t,n]=h.useState(!1),[r,c]=h.useState("connecting"),[d,g]=h.useState(null),[o]=h.useState(new A),[j,b]=h.useState(5),[v,u]=h.useState(""),[y,f]=h.useState("");h.useEffect(()=>{const m=()=>{i("/dashboard",{replace:!0})};return window.addEventListener("beforeunload",m),()=>window.removeEventListener("beforeunload",m)},[]),h.useEffect(()=>{var w,M,I;const m=(w=s.state)==null?void 0:w.currentUser,p=m==null?void 0:m.id,S=(M=s.state)==null?void 0:M.isDirectMatch,l=(I=s.state)==null?void 0:I.invitationId;if(!m||!p){i("/dashboard",{replace:!0});return}return o.isConnected()&&o.disconnect(),g(null),c("connecting"),o.cancelSearch(),o.connect(p),o.on("connect",()=>{c("connected"),S?(o.initiateDirectMatch(l,p),c("waiting for opponent")):(o.findMatch(),c("searching"))}),o.on("error",a=>{console.error("Matchmaking error:",a),c("error"),u(a.message)}),o.on("inGame",a=>{c("inGame"),u(a.message)}),o.on("alreadySearching",a=>{c("searching"),u(a.message)}),o.on("timeout",a=>{c("timeout")}),o.on("searching",a=>{c("searching")}),o.on("match_found",async a=>{var k;if(c("match_found"),f("match found"),n(!0),g(a),!a.game_id){console.error("Server did not provide game_id"),c("error"),u("Invalid game data received");return}if(a.countdown!==void 0&&b(a.countdown),a.should_navigate){const _=((k=s.state)==null?void 0:k.backgroundId)||3;setTimeout(()=>{i("/remote-game",{state:{playerNumber:a.player_number,gameId:a.game_id,opponent:a.opponent,currentUser:a.current_user,backgroundId:_}})},1e3)}}),o.on("direct_match",async a=>{var k;if(c("match_found"),f("Friendly Match"),n(!0),g(a),!a.game_id){console.error("Server did not provide game_id"),c("error"),u("Invalid game data received");return}if(a.countdown!==void 0&&b(a.countdown),a.should_navigate){const _=((k=s.state)==null?void 0:k.backgroundId)||3;i("/remote-game",{state:{playerNumber:a.player_number,gameId:a.game_id,opponent:a.opponent,currentUser:a.current_user,backgroundId:_}})}}),()=>{o.disconnect()}},[s.state]);const x=()=>{o.cancelSearch(),i("/custom")},N=()=>{switch(r){case"other_tab_active":return e.jsxs("div",{className:"w-full flex flex-col items-center gap-8 bg-backdrop-80 p-12 rounded-lg shadow-xl",children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Matchmaking In Progress"}),e.jsx("p",{children:"This game is being handled in another tab"}),e.jsx("p",{children:"Please switch to that tab or close this one"}),e.jsx("button",{onClick:x,className:"px-8 py-3 bg-primary text-backdrop-80 rounded-lg",children:"Back to Menu"})]});case"match_found":return e.jsx(O,{matchData:d,countdown:j,statement:y});case"timeout":return e.jsxs("div",{className:`w-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2
                    flex flex-col items-center gap-8 text-center z-20 timeout`,children:[e.jsx("h2",{className:"players-usernames font-heavy",children:"Time Out"}),e.jsx("p",{className:"font-medium",children:"No opponent found at the moment, Please try again later."}),e.jsx(E,{onClick:()=>i("/custom"),className:"py-3 px-6 rounded border border-border font-medium buttons-text remove-button",children:"Back to Menu"})]});case"error":case"inGame":return e.jsx("div",{className:"w-1/3 min-w-[400px]",children:e.jsxs("div",{className:"w-full flex flex-col items-center gap-8 bg-backdrop-80 p-12 rounded-lg shadow-xl",children:[e.jsx("h2",{className:"text-3xl font-bold",children:"Error"}),e.jsx("p",{children:v}),e.jsx("button",{onClick:()=>i("/custom"),className:"px-8 py-3 bg-primary text-backdrop-80 rounded-lg hover:bg-opacity-90 transition-all font-bold",children:"Go Back"})]})});default:return e.jsx("div",{className:"w-1/3 min-w-[400px] flex flex-col items-center",children:e.jsx("div",{className:"flex-grow flex items-center justify-center relative",children:r==="searching"?e.jsx($,{opponentFound:t,handleCancel:x}):null})})}};return e.jsxs("section",{className:"flex justify-center flex-1",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-10"}),N()]})};export{P as default};
