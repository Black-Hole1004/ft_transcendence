import{r as s,j as e,a as F,f as S,b as P,R as B,c as ee,u as se,h as W,O as te}from"./index-B4bz0GvT.js";import{B as D}from"./Button-DzeJS1SW.js";const re=({layout:i,type:a,message:h,onClose:m})=>{const g={info:"bg-blue-500 bg-opacity-10 border-blue-500 text-blue-100",error:"bg-red-500 bg-opacity-10 border-red-500 text-red-100",success:"bg-green-500 bg-opacity-10 border-green-500 text-green-100",warning:"bg-yellow-500 bg-opacity-10 border-yellow-500 text-yellow-100"},x={info:"bg-blue-500",error:"bg-red-500",success:"bg-green-500",warning:"bg-yellow-500"},[u,v]=s.useState(3e3);return s.useEffect(()=>{u>0&&setTimeout(()=>v(f=>f-20),20)},[u]),e.jsxs("div",{className:`alert absolute z-20 ${i?"top-full":""} right-2 backdrop-brightness-0 font-medium border-l-4
			flex flex-col border alert rounded ${g[a]}`,role:"alert",children:[e.jsxs("div",{className:"flex items-center justify-between h-[98%] lp:p-6 p-3",children:[e.jsxs("div",{className:"flex gap-3 items-center mr-4",children:[e.jsx("img",{src:`/assets/images/icons/${a}.png`,className:"alert-icon",alt:""}),e.jsx("span",{children:h})]}),e.jsx("button",{className:"focus:outline-none px-2",onClick:m,children:"Ã—"})]}),e.jsx("div",{className:`${x[a]} h-0.5 rounded-r`,style:{width:`${u/3e3*100}%`}})]})},ne="https://localhost";function oe({setIsDropdownOpen:i,user_data:a}){const{logout:h}=F(),m=()=>{i(!1)};return e.jsxs(e.Fragment,{children:[e.jsx(S,{to:`/profile/${a.username}`,children:e.jsxs("div",{onClick:m,className:"flex items-center gap-1",children:[e.jsx("img",{src:`${ne}${a.profile_picture}`,className:"rounded-full object-cover ring-1 ring-primary dropdown-user-photo",alt:"user photo"}),e.jsxs("div",{className:"font-medium",children:[e.jsxs("p",{className:"text-primary fullname",children:[a.first_name," ",a.last_name]}),e.jsxs("p",{className:"text-light username",children:["@",a.username]})]})]})}),e.jsx("div",{className:"h-px w-[80%] bg-border self-center"}),e.jsxs("ul",{className:"font-medium text-primary flex flex-col tb:gap-2.5 gap-1.5",children:[e.jsx(S,{to:`/profile/${a.username}`,children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/profile.svg",alt:"profile icon"}),"Profile"]})}),e.jsx(S,{to:"/dashboard",children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/dashboard.svg",alt:"dashboard icon"}),"Dashboard"]})}),e.jsx(S,{to:"/settings",children:e.jsxs("li",{onClick:m,className:"flex items-center gap-4 hover:brightness-150",children:[e.jsx("img",{src:"/assets/images/icons/settings.svg",alt:"settings icon"}),"Settings"]})})]}),e.jsx("div",{className:"h-[1px] w-[80%] bg-border self-center"}),e.jsx("ul",{children:e.jsxs("li",{onClick:h,className:"flex items-center gap-4 hover:brightness-150 cursor-pointer",children:[e.jsx("img",{src:"/assets/images/icons/log-out.svg",alt:"logout icon"}),"Log Out"]})})]})}const L="https://localhost",ae="https://localhost/api/friend_request/accept/",ie="https://localhost/api/friend_request/cancel/";function ce({notifications:i,setNotifications:a,setIsNotificationOpen:h}){const{getAuthHeaders:m}=F(),{triggerAlert:g}=P();q();const{handleGameInviteResponse:x}=q(),u=(r,t)=>{g(r,t)},v=async r=>{if(!r){console.error("No friend request ID provided");return}try{const t=await fetch(`${ae}${r}/`,{method:"POST",headers:m()}),o=await t.json();t.status===201?(a(d=>d.filter(b=>b.id!==r)),u("success",o.message)):(console.error("Error accepting friend request --->",o.message),a(d=>d.filter(b=>b.id!==r)),u("error",o.message)),h(!1)}catch{u("error","Error accepting friend request")}},f=async r=>{if(!r){console.error("No friend request ID provided");return}try{const t=await fetch(`${ie}${r}/`,{method:"POST",headers:m()}),o=await t.json();t.status===201?(a(d=>d.filter(b=>b.id!==r)),u("success",o.message)):u("error",o.message),h(!1)}catch(t){console.error("Error canceling friend request:",t),h(!1),u("error","Error canceling friend request")}};s.useEffect(()=>{(async()=>{try{const t=await fetch(`${L}/api/friend_ship_request/`,{headers:m()});if(t.ok){const d=(await t.json()).map(b=>({...b,flag:"true"}));a(d)}else console.error("Failed to fetch notifications")}catch(t){console.error("Error fetching notifications:",t)}})()},[]),s.useEffect(()=>{(async()=>{try{const t=await fetch(`${L}/api/game/pending-game-invites/`,{headers:m()});if(t.ok){const o=await t.json();a(d=>[...d.filter(j=>j.type!=="game_invite"),...o])}}catch(t){console.error("Error fetching pending invites:",t)}})()},[]);const w=(r,t)=>{x(r,t),a(o=>o.filter(d=>d.invitation_id!==r))},y=({notification:r,onExpire:t,onResponse:o})=>{const[d,b]=s.useState(()=>{const I=Math.floor(Date.now()/1e3)-r.created_at;return Math.max(60-I,0)}),[j,O]=s.useState(d===0);s.useEffect(()=>{if(d===0){O(!0),t();return}const k=setInterval(()=>{b(I=>{const $=I-1;return $<=0?(clearInterval(k),O(!0),t(),0):$})},1e3);return()=>clearInterval(k)},[d,t]);const C=k=>{if(j){g("error","Cannot respond to expired invitation");return}o(r.invitation_id,k)};return e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:r.profile_picture,className:"mtb:border aspect-square object-cover border-0.7 border-primary rounded-full notification-img",alt:"User Avatar"}),e.jsxs("div",{children:[e.jsxs("p",{children:[r.from_user," invited you to play!"]}),e.jsxs("p",{className:`text-sm ${d<=10?"text-red-400":"text-gray-400"}`,children:["Expires in ",Math.floor(d),"s"]})]})]}),e.jsxs("div",{className:"flex gap-1 mr-1",children:[e.jsx(D,{className:`notification-buttons rounded-md ${j?"opacity-50 cursor-not-allowed":""}`,onClick:()=>C("accept"),disabled:j,children:"Accept"}),e.jsx(D,{className:`notification-buttons rounded-md ${j?"opacity-50 cursor-not-allowed":""}`,onClick:()=>C("decline"),disabled:j,children:"Decline"})]})]})},_=(r,t)=>r.type==="game_invite"?e.jsxs(B.Fragment,{children:[e.jsx(y,{notification:r,onExpire:()=>{a(o=>o.filter(d=>d.invitation_id!==r.invitation_id))},onResponse:w}),t<i.length-1&&e.jsx("div",{className:"h-px w-[80%] bg-border self-center"})]},t):e.jsxs(B.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("img",{src:r.profile_picture,className:"mtb:border object-cover aspect-square border-0.7 border-primary rounded-full notification-img",alt:"User Avatar"}),r.flag?e.jsxs("p",{children:[r.username," sent you a Friend Request!"]}):e.jsxs("p",{children:[r.from_user," sent you a Friend Request!"]})]}),e.jsxs("div",{className:"flex gap-1 mr-1",children:[e.jsx(D,{className:"notification-buttons rounded-md",onClick:()=>v(r.id),children:"Accept"}),e.jsx(D,{className:"notification-buttons rounded-md",onClick:()=>f(r.id),children:"Cancel"})]})]}),t<i.length-1&&e.jsx("div",{className:"h-px w-[80%] bg-border self-center"})]},t),p=()=>e.jsxs("div",{className:"flex-1 flex flex-col justify-center items-center",children:[e.jsx("img",{src:"/assets/images/emptyStates/notifications.svg",className:"w-[50%]",alt:"notification empty state"}),e.jsx("h2",{className:"",children:"No notifications"}),e.jsx("p",{className:"font-regular bio",children:"Notification Inbox Empty"})]});return e.jsxs(e.Fragment,{children:[e.jsx("h1",{className:"font-heavy notification-header",children:"Notifications"}),e.jsx("div",{className:"flex flex-col tb:gap-3 gap-2 overflow-auto lp:mx-3 mx-2 mb-2 font-medium",children:(i==null?void 0:i.length)>0?i.map((r,t)=>_(r,t)):p()})]})}s.createContext();const le="https://localhost";function de({user_data:i,notifications:a,setNotifications:h}){const m=ee().pathname.split("/").slice(1,2),[g,x]=s.useState(!1),[u,v]=s.useState(!1),f=s.useRef(null),w=s.useRef(null),y=s.useRef(null),_=s.useRef(null);s.useEffect(()=>{const t=o=>{g&&f.current&&!f.current.contains(o.target)&&!w.current.contains(o.target)&&x(!1),u&&y.current&&!y.current.contains(o.target)&&!_.current.contains(o.target)&&v(!1)};return document.addEventListener("click",t),()=>{document.removeEventListener("click",t)}},[g,u]);const p=()=>{x(!g),v(!1)},r=()=>{v(!u),x(!1)};return e.jsxs("header",{className:`relative flex items-center justify-between text-primary header-margin font-medium
			lp:border-b-2 border-b-[1px] border-white header-border header-height max-ms:justify-end z-50`,children:[e.jsx(pe,{layout:!0}),e.jsx(S,{to:"/dashboard","aria-label":"Go to Dashboard",children:e.jsx("img",{alt:"logo",src:"/assets/images/logo.webp",className:"select-none pointer-events-none header-logo max-ms:hidden"})}),e.jsx(S,{to:"/dashboard",children:e.jsx("h1",{className:"leading-[1.1] text-primary font-dreamscape select-none header-title-font max-ml:hidden",children:"starserve"})}),e.jsxs("nav",{className:"relative flex justify-between ml:gap-x-2.5 ms:gap-x-1.5",children:[e.jsx("div",{className:`relative ${m[0]==="chat"?"pointer-events-none":""}`,children:e.jsx(S,{to:"/chat",children:e.jsx("img",{src:"/assets/images/icons/chat.svg",alt:"chat icon",className:`nav-icons select-none ${m[0]==="chat"?"":"hover:brightness-200 transition duration-300"}`})})}),e.jsxs("button",{ref:_,onClick:r,className:"relative",children:[e.jsx("img",{src:"/assets/images/icons/notification.svg",alt:"notification icon",className:"nav-icons select-none hover:brightness-200 transition duration-300"}),!u&&e.jsx("div",{className:`flex justify-center items-center bg-red-600 border border-[#0B0B0B]
						h-[30%] absolute rounded-full right-0 top-0`,children:(a==null?void 0:a.length)>0?e.jsx("p",{className:"font-heavy text-[10px] p-0.5",children:a.length>99?"+99":a.length}):null})]}),e.jsx("div",{ref:y,className:`notification max-ms:w-full absolute z-50 ml:right-1/3 right-0
							top-full flex flex-col border border-primary rounded-xl bg-secondary
							transition-opacity duration-300 ${u?"opacity-100":"pointer-events-none opacity-0"}`,children:e.jsx(ce,{notifications:a,setNotifications:h,setIsNotificationOpen:v})}),e.jsxs("button",{ref:w,onClick:p,type:"button",className:"relative",children:[e.jsx("img",{src:`${le}${i.profile_picture}`,alt:"user photo",className:"nav-icons object-cover rounded-full ring-1 ring-primary select-none"}),e.jsx("div",{className:`flex justify-center items-center bg-secondary border border-[#0B0B0B]
						w-[34%] h-[34%] absolute z-10 rounded-full right-0 bottom-0`,children:e.jsx("img",{src:"/assets/images/icons/Arrow-dropdown.svg",className:`w-[60%] select-none duration-300 ${g?"rotate-180":""}`,alt:"arrow icon"})})]}),e.jsx("div",{ref:f,className:`dropdown absolute right-0 top-full flex flex-col border border-primary rounded-xl bg-secondary
						transition-opacity duration-300 ${g?"opacity-100":"pointer-events-none opacity-0"}`,children:e.jsx(oe,{setIsDropdownOpen:x,user_data:i})})]})]})}const me="https://localhost/api/user/",ue="wss://localhost/ws/notify/",fe="wss://localhost/ws/friends/",ge="wss://localhost/ws/notifications/",U=s.createContext(),q=()=>s.useContext(U);function Se(){const{authTokens:i,getAuthHeaders:a}=F(),[h,m]=s.useState(0),[g,x]=s.useState(null),[u,v]=s.useState(null),[f,w]=s.useState(null),[y,_]=s.useState([]),{triggerAlert:p}=P(),r=se(),t=()=>{m(n=>n+1)},[o,d]=s.useState({first_name:"",last_name:"",email:"",mobile_number:"",username:"",bio:"",password:"",new_password:"",confirm_password:"",profile_picture:"",is_logged_with_oauth_for_2fa:!1}),[b,j]=s.useState(""),[O,C]=s.useState(""),[k,I]=s.useState(""),[$,M]=s.useState(""),[he,J]=s.useState(""),[xe,z]=s.useState(!1),[be,H]=s.useState(""),[Q,Y]=s.useState("");s.useState(""),s.useState("");const G=async()=>{try{const n=await fetch(me,{method:"GET",headers:a()}),l=await n.json();return n.ok?l:(W.remove("access_token"),W.remove("refresh_token"),window.location.href="/",null)}catch(n){return console.log(n),null}},[E]=s.useState(sessionStorage.getItem("tabId")||Math.random().toString(36).substr(2,9));s.useEffect(()=>{sessionStorage.setItem("tabId",E)},[]),s.useEffect(()=>{if(!(i!=null&&i.access_token)){logout();return}(async()=>{const l=await G();l?d(l):console.log("-- Failed to fetch user data --")})()},[i,h]),s.useEffect(()=>{o&&(j(o.first_name),C(o.last_name),I(o.email),M(o.mobile_number),J(o.username),H(o.bio),Y(o.profile_picture),z(o.is_logged_with_oauth_for_2fa))},[o]);const A=W.get("access_token");if(!A)return;s.useEffect(()=>{const n=new WebSocket(ue+"?access_token="+A);return n.onopen=()=>{},n.onmessage=l=>{JSON.parse(l.data)},n.onclose=l=>{},n.onerror=l=>{console.error("WebSocket Error:",l)},x(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]),s.useEffect(()=>{const n=new WebSocket(fe+"?access_token="+A);return n.onopen=()=>{console.log("---- WebSocket Connected from AcceptFriendsRequest Consumer ----")},n.onmessage=l=>{JSON.parse(l.data)},n.onclose=l=>{console.log("WebSocket Closed form AcceptFriendsRequest Consumer:",l)},n.onerror=l=>{console.error("WebSocket Error:",l)},v(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]),s.useEffect(()=>{const n=new WebSocket(ge+"?access_token="+A);return n.onopen=()=>{console.log("---- WebSocket Connected from Notifications Consumer ----")},n.onmessage=l=>{console.log("WebSocket message received:x",l.data);const c=JSON.parse(l.data);switch(c.type){case"game_invite":_(N=>[...N,{type:"game_invite",from_user:c.sender.username,profile_picture:c.sender.profile_picture,sender_id:c.sender.id,invitation_id:c.invitation_id,created_at:c.created_at}]);break;case"invite_failed":p("error",c.message);break;case"game_invite_accepted":const R=c.sender.id===c.user.id,V=c.acceptingTabId===E,X=localStorage.getItem("gameSenderTab"),Z=R&&X===E;if(c.sender.status==="offline"){p("info",`${c.sender.username} is offline`);return}if(c.sender.status==="ingame"){p("info",`${c.sender.username} is in a game`);return}R?p("success",`${c.receiver.username} accepted your invitation`):p("success","Starting game..."),R&&Z||!R&&V?(console.log("Navigating to matchmaking in tab:",E),localStorage.setItem("activeGame",JSON.stringify({gameId:c.invitation_id,activeTabId:E,timestamp:Date.now()})),r("/matchmaking",{state:{backgroundId:1,currentUser:c.user,isDirectMatch:!0,invitationId:c.invitation_id}})):console.log("Not navigating in this tab");break;case"game_invite_declined":c.sender.id===c.user.id&&p("info",`${c.receiver.username} declined your game invitation`);break;case"game_invite_expired":_(N=>N.filter(T=>T.invitation_id!==c.invitation_id)),p("info","Game invitation expired");break;case"error":c.message.includes("expired")?_(N=>N.filter(T=>T.invitation_id!==c.invitation_id)):p("error",c.message);break;default:_(N=>[...N,{id:c.id,message:c.message,type:"friend_request",from_user:c.from_user,profile_picture:c.profile_picture}])}},n.onclose=l=>{console.log("WebSocket Closed form Notifications Consumer:",l)},n.onerror=l=>{console.error("WebSocket Error:",l)},w(n),()=>{n.readyState===WebSocket.OPEN&&n.close()}},[i==null?void 0:i.access_token]);const K={socket_notify:g,socket_friends:u,socket_notification:f,refreshUserData:t,fetchUser:G,profile_picture:Q,handleGameInviteResponse:(n,l)=>{(f==null?void 0:f.readyState)===WebSocket.OPEN&&f.send(JSON.stringify({type:"game_invite_response",invitation_id:n,response:l,acceptingTabId:E}))},sendGameInvite:n=>{if((f==null?void 0:f.readyState)===WebSocket.OPEN){const l=sessionStorage.getItem("tabId");localStorage.setItem("gameSenderTab",l),f.send(JSON.stringify({type:"game_invite",receiver_id:n,senderTabId:l})),p("success","Game invitation sent successfullyy")}else p("error","Cannot send invite - connection error")}};return e.jsx(U.Provider,{value:K,children:e.jsxs("div",{className:"relative flex flex-col min-h-screen backdrop-blur-sm bg-backdrop-40 text-primary overflow-hidden",children:[e.jsx(de,{user_data:o,notifications:y,setNotifications:_}),e.jsx(te,{})]})})}const pe=({layout:i})=>{const{showAlert:a,alertType:h,alertMessage:m,dismissAlert:g}=P();return s.useEffect(()=>{if(a){const x=setTimeout(()=>{g()},3200);return()=>clearTimeout(x)}},[a,g]),a&&e.jsx(re,{layout:i,type:h,message:m,onClose:g})};export{pe as AlertWrapper,Se as default,q as useSocket};
